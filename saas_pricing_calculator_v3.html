<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Precifica√ß√£o SaaS ‚Äî Info √Ågil v3</title>
  <style>
    :root {
      --bg1:#0f172a; --bg2:#111827;
      --card:#0b1220; --muted:#9ca3af;
      --brand:#22d3ee; --brand2:#7c3aed;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1000px 500px at 10% 0%, var(--bg1), var(--bg2));
      color:#e5e7eb; padding:22px;
    }
    .wrap{max-width:1200px; margin:0 auto;}
    .hero{padding:20px 16px 8px; text-align:center}
    .hero h1{margin:0 0 8px;font-size:clamp(22px,3vw,36px); font-weight:700; letter-spacing:.2px}
    .hero p{margin:0; color:var(--muted)}
    .grid{display:grid; gap:16px; grid-template-columns: 1fr 1fr;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    h2{font-size:18px; margin:0 0 14px; font-weight:700; color:#fff}
    .subtle{color:var(--muted); font-size:13px}
    label{display:block; font-size:13px; color:#cbd5e1; margin:10px 0 6px}
    input[type="number"]{
      width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
    }
    input[type="number"]:focus{border-color:var(--brand)}
    .row{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px}
    .row3{display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px}
    .row5{display:grid; grid-template-columns: repeat(5,minmax(0,1fr)); gap:10px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:0; padding:10px 14px; border-radius:10px; cursor:pointer; color:#0b1220; font-weight:700;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
    }
    .ghost{background:transparent; color:#e5e7eb; border:1px solid rgba(255,255,255,.16)}
    .cards{display:grid; grid-template-columns: repeat(5,minmax(0,1fr)); gap:10px}
    @media (max-width: 1100px){ .cards{grid-template-columns: repeat(2,minmax(0,1fr));} }
    @media (max-width: 600px){ .cards{grid-template-columns: 1fr;} }
    .pricing{background:linear-gradient(135deg, rgba(34,211,238,.08), rgba(124,58,237,.08)); border:1px solid rgba(34,211,238,.25)}
    .price{font-size:26px; font-weight:800; margin:4px 0 8px}
    .mut{color:var(--muted); font-size:12px}
    .metric-grid{display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:10px; margin-top:12px}
    @media (max-width: 1100px){ .metric-grid{grid-template-columns: repeat(2,minmax(0,1fr));} }
    .metric{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px}
    .metric .val{font-size:20px; font-weight:800}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .b-ok{background:rgba(34,197,94,.15); color:#22c55e; border:1px solid rgba(34,197,94,.35)}
    .b-warn{background:rgba(245,158,11,.15); color:#f59e0b; border:1px solid rgba(245,158,11,.35)}
    .b-dang{background:rgba(239,68,68,.15); color:#ef4444; border:1px solid rgba(239,68,68,.35)}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,.08)}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px}
    .p-high{background:rgba(34,197,94,.15); color:#22c55e}
    .p-med{background:rgba(245,158,11,.15); color:#f59e0b}
    .p-low{background:rgba(239,68,68,.15); color:#ef4444}
    .hint{font-size:12px;color:var(--muted)}
    .right{text-align:right}
    .center{text-align:center}
    select{
      width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
    }
    select:focus{border-color:var(--brand)}
    input[type="text"]{
      width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
    }
    input[type="text"]:focus{border-color:var(--brand)}
    h3{font-size:16px; margin:15px 0 10px; font-weight:600; color:#fff}
    textarea{
      width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none; resize:vertical;
    }
    textarea:focus{border-color:var(--brand)}
    input[type="checkbox"]{
      width:16px; height:16px; margin-right:8px; accent-color:var(--brand);
    }
    .alert{
      padding:12px; border-radius:8px; margin:10px 0; font-size:13px;
    }
    .alert-warn{background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.35); color:#f59e0b}
    .alert-danger{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35); color:#ef4444}
    .alert-info{background:rgba(34,211,238,.15); border:1px solid rgba(34,211,238,.35); color:#22d3ee}
    .auto-correct{background:rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.3)}
    .validation-error{border-color:var(--danger) !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>üí∞ Calculadora de Precifica√ß√£o SaaS ‚Äî Info √Ågil</h1>
      <p class="subtle">valida√ß√µes matem√°ticas, an√°lise de cohort, segmenta√ß√£o de CAC e proje√ß√µes realistas</p>
    </div>

    <!-- Alertas de Valida√ß√£o -->
    <div id="alertasValidacao"></div>

    <section class="card" style="margin-bottom:16px; background:linear-gradient(135deg, rgba(34,211,238,.08), rgba(124,58,237,.08)); border:1px solid rgba(34,211,238,.25)">
      <h2>üè¢ Modelo de Neg√≥cio</h2>
      <div class="row">
        <div>
          <label>Tipo de Opera√ß√£o</label>
          <select id="tipoOperacao">
            <option value="white_label">White Label (Avante)</option>
            <option value="proprio">Desenvolvimento Pr√≥prio</option>
            <option value="hibrido">H√≠brido (White + Pr√≥prio)</option>
          </select>
        </div>
        <div>
          <label>Segmento Principal</label>
          <select id="segmentoPrincipal">
            <option value="contabil">Cont√°bil/Fiscal</option>
            <option value="geral">Gest√£o Empresarial</option>
            <option value="especializado">Nicho Especializado</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Regi√£o de Atua√ß√£o</label>
          <select id="regiaoAtuacao">
            <option value="local">Local/Regional</option>
            <option value="nacional">Nacional</option>
            <option value="internacional">Internacional</option>
          </select>
        </div>
        <div>
          <label>Estrat√©gia de Crescimento</label>
          <select id="estrategiaCrescimento">
            <option value="organico">Org√¢nico</option>
            <option value="agressivo">Agressivo (Investimento)</option>
            <option value="conservador">Conservador</option>
          </select>
        </div>
      </div>
    </section>

    <div class="grid">
    <section class="card">
      <h2>üìä Custos Fixos Mensais Detalhados</h2>
      <div class="row">
        <div>
          <label>Pessoal (Sal√°rios + Encargos) (R$)</label>
          <input id="custosPessoal" type="number" min="0" step="100" value="8000"/>
        </div>
        <div>
          <label>Infraestrutura (Servidores + TI) (R$)</label>
          <input id="infraestrutura" type="number" min="0" step="50" value="800"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Marketing Digital (R$)</label>
          <input id="marketing" type="number" min="0" step="100" value="2000"/>
        </div>
        <div>
          <label>Administrativo (Contador, Jur√≠dico) (R$)</label>
          <input id="contador" type="number" min="0" step="100" value="800"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Comunica√ß√£o (Telefone, Internet) (R$)</label>
          <input id="comunicacao" type="number" min="0" step="10" value="250"/>
        </div>
        <div>
          <label>Outros (Escrit√≥rio, Diversos) (R$)</label>
          <input id="outros" type="number" min="0" step="50" value="350"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Licenciamento/White Label (R$)</label>
          <input id="setupAvante" type="number" min="0" step="50" value="792"/>
        </div>
        <div>
          <label>Reserva de Conting√™ncia (R$)</label>
          <input id="custosContingencia" type="number" min="0" step="100" value="500"/>
        </div>
      </div>
      
      <h3 style="margin-top:20px; margin-bottom:10px">üí∞ Custos Vari√°veis por Cliente/M√™s</h3>
      <div class="subtle" style="margin-bottom:10px">Base + Suporte diferenciados por plano</div>
      <div class="row5">
        <div><label class="hint">MEI - Base (R$)</label><input id="custoMei" type="number" min="0" step="1" value="25"/></div>
        <div><label class="hint">Contador - Base (R$)</label><input id="custoContador" type="number" min="0" step="1" value="30"/></div>
        <div><label class="hint">B√°sico - Base (R$)</label><input id="custoBasico" type="number" min="0" step="1" value="36"/></div>
        <div><label class="hint">Inter - Base (R$)</label><input id="custoInter" type="number" min="0" step="1" value="56"/></div>
        <div><label class="hint">Premium - Base (R$)</label><input id="custoPremium" type="number" min="0" step="1" value="130"/></div>
      </div>
      <div class="row5" style="margin-top:10px">
        <div><label class="hint">MEI - Suporte (R$)</label><input id="suporteMei" type="number" min="0" step="5" value="20"/></div>
        <div><label class="hint">Contador - Suporte (R$)</label><input id="suporteContador" type="number" min="0" step="5" value="30"/></div>
        <div><label class="hint">B√°sico - Suporte (R$)</label><input id="suporteBasico" type="number" min="0" step="5" value="35"/></div>
        <div><label class="hint">Inter - Suporte (R$)</label><input id="suporteInter" type="number" min="0" step="5" value="50"/></div>
        <div><label class="hint">Premium - Suporte (R$)</label><input id="suportePremium" type="number" min="0" step="5" value="80"/></div>
      </div>
    </section>      <section class="card">
        <h2>üéØ Par√¢metros de Neg√≥cio</h2>
        <div class="subtle" style="margin-bottom:10px">Valores com valida√ß√£o autom√°tica e auto-corre√ß√£o</div>

        <div class="row">
          <div>
            <label>Margem de Lucro Desejada (%)</label>
            <input id="margemLucro" type="number" min="0" max="100" step="1" value="40"/>
          </div>
          <div>
            <label>Meta de Clientes (m√™s 12)</label>
            <input id="metaClientes" type="number" min="1" step="1" value="120"/>
          </div>
        </div>

        <label>Distribui√ß√£o de Planos (%) <span class="subtle" id="somaDistribuicao">Total: 100%</span></label>
        <div class="row5">
          <div><label class="hint">MEI</label><input id="distribMei" type="number" min="0" max="100" step="1" value="15" oninput="validarDistribuicao()"/></div>
          <div><label class="hint">Contador</label><input id="distribContador" type="number" min="0" max="100" step="1" value="20" oninput="validarDistribuicao()"/></div>
          <div><label class="hint">B√°sico</label><input id="distribBasico" type="number" min="0" max="100" step="1" value="30" oninput="validarDistribuicao()"/></div>
          <div><label class="hint">Inter</label><input id="distribInter" type="number" min="0" max="100" step="1" value="25" oninput="validarDistribuicao()"/></div>
          <div><label class="hint">Premium</label><input id="distribPremium" type="number" min="0" max="100" step="1" value="10" oninput="validarDistribuicao()"/></div>
        </div>
        <button class="ghost" onclick="autoCorrigirDistribuicao()" style="margin-top:5px; padding:5px 10px; font-size:12px">‚ö° Auto-corrigir para 100%</button>

        <div class="row" style="margin-top:15px">
          <div>
            <label>Churn Rate M√©dio (%/m√™s)</label>
            <input id="churnRate" type="number" min="0" max="50" step="0.1" value="4"/>
          </div>
          <div>
            <label>Churn Melhorado ap√≥s 6 meses (%/m√™s)</label>
            <input id="churnMelhorado" type="number" min="0" max="50" step="0.1" value="2.5"/>
          </div>
        </div>

        <h3 style="margin-top:15px">CAC Segmentado por Plano</h3>
        <div class="row5">
          <div><label class="hint">MEI - CAC (R$)</label><input id="cacMei" type="number" min="0" step="10" value="150"/></div>
          <div><label class="hint">Contador - CAC (R$)</label><input id="cacContador" type="number" min="0" step="10" value="200"/></div>
          <div><label class="hint">B√°sico - CAC (R$)</label><input id="cacBasico" type="number" min="0" step="10" value="250"/></div>
          <div><label class="hint">Inter - CAC (R$)</label><input id="cacInter" type="number" min="0" step="10" value="350"/></div>
          <div><label class="hint">Premium - CAC (R$)</label><input id="cacPremium" type="number" min="0" step="10" value="500"/></div>
        </div>

        <div class="row" style="margin-top:15px">
          <div>
            <label>Impostos (% sobre pre√ßo)</label>
            <input id="impostos" type="number" min="0" max="50" step="0.5" value="8.5"/>
          </div>
          <div>
            <label>Comiss√µes (% sobre pre√ßo)</label>
            <input id="comissoes" type="number" min="0" max="30" step="0.5" value="7"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>White Label ‚Äî Taxa sobre Receita (%)</label>
            <input id="whiteLabelPct" type="number" min="0" max="100" step="1" value="30"/>
          </div>
          <div>
            <label>Sazonalidade Cont√°bil - Multiplicador</label>
            <input id="sazonalidade" type="number" min="1" max="3" step="0.1" value="1.5"/>
          </div>
        </div>

        <div class="actions">
          <button onclick="calcular()">üîÑ Calcular Pre√ßos</button>
          <button class="ghost" onclick="resetarPadrao()">üîÑ Resetar Padr√£o</button>
          <button class="ghost" onclick="testeRapido()">üîß Debug</button>
          <button class="ghost" onclick="exportarJSON()">üì§ Exportar JSON</button>
        </div>
      </section>
    </div>

    <section class="card pricing" style="margin-top:16px">
      <h2>üíé Precifica√ß√£o Recomendada</h2>
      <div class="subtle" style="margin-bottom:10px">
        F√≥rmula: <code>P = (Custo Direto / (1 - Margem)) / (1 - Impostos - Comiss√µes - WhiteLabel)</code>
      </div>
      <div class="cards" id="cards"></div>

      <div class="metric-grid">
        <div class="metric"><div class="val" id="mrrTotal">R$ 0</div><div class="subtle">MRR Projetado</div></div>
        <div class="metric"><div class="val" id="custosFixosTotal">R$ 0</div><div class="subtle">Custos Fixos</div></div>
        <div class="metric"><div class="val" id="breakEven">0</div><div class="subtle">Break-even (clientes)</div></div>
        <div class="metric"><div class="val" id="ltv">R$ 0</div><div class="subtle">LTV M√©dio</div></div>
        <div class="metric"><div class="val" id="ltvCacRatio">0x</div><div class="subtle">LTV/CAC</div></div>
        <div class="metric"><div class="val" id="receitaAnual">R$ 0</div><div class="subtle">Receita Anual</div></div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>üéÅ Cat√°logo de Adicionais ‚Äî Upsell</h2>
      <p class="subtle">Configure seus pr√≥prios adicionais e suas margens de lucro.</p>
      <div class="row">
        <div>
          <label>Margem sobre Adicionais (%)</label>
          <input id="margemAdicionais" type="number" min="0" max="200" step="1" value="50"/>
        </div>
        <div>
          <label>Ades√£o m√©dia (para m√©tricas) ‚Äî Muito/Moderado/Opcional (%)</label>
          <div class="row3">
            <input id="txMuito" type="number" min="0" max="100" step="1" value="70"/>
            <input id="txMod" type="number" min="0" max="100" step="1" value="40"/>
            <input id="txOpc" type="number" min="0" max="100" step="1" value="20"/>
          </div>
        </div>
      </div>

      <h3 style="margin-top:15px">‚úèÔ∏è Adicionais Customiz√°veis</h3>
      <div class="row">
        <div>
          <label>Adicionar Novo Item</label>
          <input id="novoAdicional" type="text" placeholder="Nome do adicional"/>
        </div>
        <div>
          <label>Custo (R$)</label>
          <input id="novoCusto" type="number" min="0" step="1" value="20"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Categoria</label>
          <select id="novaCategoria" style="width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; font-size:14px;">
            <option value="muito">Muito Recomendado</option>
            <option value="moderado">Moderado</option>
            <option value="opcional">Opcional</option>
          </select>
        </div>
        <div style="display:flex; align-items:end;">
          <button onclick="adicionarItem()" style="width:100%">‚ûï Adicionar</button>
        </div>
      </div>

      <div class="row3" id="addonsTables"></div>

      <div class="metric-grid" style="margin-top:10px">
        <div class="metric"><div class="val" id="receitaAdicionaisMensal">R$ 0</div><div class="subtle">Receita Mensal ‚Äî Adicionais</div></div>
        <div class="metric"><div class="val" id="margemAdicionaisMensal">R$ 0</div><div class="subtle">Margem ‚Äî Adicionais</div></div>
        <div class="metric"><div class="val" id="ticketMedioComAdicionais">R$ 0</div><div class="subtle">Ticket M√©dio com Adicionais</div></div>
      </div>
    </section>

    <!-- NOVA SE√á√ÉO: AN√ÅLISE DE CONCORR√äNCIA -->
    <section class="card" style="margin-top:16px">
      <h2>üéØ An√°lise de Concorr√™ncia e Ajuste de Mercado</h2>
      <div class="subtle" style="margin-bottom:15px">
        Compare seus pre√ßos com a concorr√™ncia e receba sugest√µes autom√°ticas de ajuste
      </div>

      <h3>üìä Pre√ßos dos Concorrentes</h3>
      <div class="row5" style="margin-bottom:15px">
        <div><label class="hint">Concorrente MEI (R$)</label><input id="concorrenteMei" type="number" min="0" step="1" value="0" onchange="analisarConcorrencia()"/></div>
        <div><label class="hint">Concorrente Contador (R$)</label><input id="concorrenteContador" type="number" min="0" step="1" value="0" onchange="analisarConcorrencia()"/></div>
        <div><label class="hint">Concorrente B√°sico (R$)</label><input id="concorrenteBasico" type="number" min="0" step="1" value="0" onchange="analisarConcorrencia()"/></div>
        <div><label class="hint">Concorrente Inter (R$)</label><input id="concorrenteInter" type="number" min="0" step="1" value="0" onchange="analisarConcorrencia()"/></div>
        <div><label class="hint">Concorrente Premium (R$)</label><input id="concorrentePremium" type="number" min="0" step="1" value="0" onchange="analisarConcorrencia()"/></div>
      </div>

      <div class="row" style="margin-bottom:15px">
        <div>
          <label>Estrat√©gia de Posicionamento</label>
          <select id="estrategiaPosicionamento" onchange="analisarConcorrencia()">
            <option value="competitivo">Competitivo (-5% a +5%)</option>
            <option value="premium">Premium (+10% a +20%)</option>
            <option value="agressivo">Agressivo (-10% a -20%)</option>
            <option value="value">Valor Agregado (+5% a +15%)</option>
          </select>
        </div>
        <div>
          <label>Fator de Ajuste Manual (%)</label>
          <input id="ajusteManual" type="number" min="-50" max="50" step="1" value="0" onchange="analisarConcorrencia()"/>
        </div>
      </div>

      <div class="actions" style="margin-bottom:20px">
        <button onclick="analisarConcorrencia()">üîç Analisar Concorr√™ncia</button>
        <button class="ghost" onclick="aplicarSugestoes()">‚úÖ Aplicar Sugest√µes</button>
        <button class="ghost" onclick="limparConcorrencia()">üóëÔ∏è Limpar</button>
      </div>

      <!-- Resultados da An√°lise -->
      <div id="resultadosConcorrencia" style="display:none;">
        <h3>üìà An√°lise Comparativa</h3>
        <div class="cards" id="cardsComparacao" style="margin-bottom:20px"></div>

        <h3>üí° Sugest√µes de Ajuste</h3>
        <div id="sugestoesAjuste"></div>

        <h3>üìä Impacto Financeiro</h3>
        <div class="metric-grid" style="grid-template-columns: repeat(4,minmax(0,1fr));">
          <div class="metric">
            <div class="val" id="impactoMRR">R$ 0</div>
            <div class="subtle">Impacto no MRR</div>
          </div>
          <div class="metric">
            <div class="val" id="impactoAnual">R$ 0</div>
            <div class="subtle">Impacto Anual</div>
          </div>
          <div class="metric">
            <div class="val" id="novaMargemMedia">0%</div>
            <div class="subtle">Nova Margem M√©dia</div>
          </div>
          <div class="metric">
            <div class="val" id="competitividadeScore">0/10</div>
            <div class="subtle">Score Competitividade</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>üìà Proje√ß√µes e Cen√°rios</h2>
      <div class="row">
        <div>
          <label>Crescimento Mensal de Clientes (%)</label>
          <input id="crescimentoMensal" type="number" min="0" max="100" step="1" value="8"/>
        </div>
        <div>
          <label>Per√≠odo de Proje√ß√£o (meses)</label>
          <input id="periodoProjecao" type="number" min="1" max="60" step="1" value="12"/>
        </div>
      </div>
      
      <div class="row">
        <div>
          <label>Meta Receita Mensal no Final do Per√≠odo (R$)</label>
          <input id="metaReceitaFinal" type="number" min="0" step="1000" value="50000"/>
        </div>
        <div>
          <label>Churn Melhorado ap√≥s 6 meses (%/m√™s)</label>
          <input id="churnMelhorado" type="number" min="0" max="50" step="0.1" value="2.5"/>
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button onclick="calcularProjecoes()">üìä Calcular Proje√ß√µes</button>
        <button class="ghost" onclick="resetarPadrao()">üîÑ Resetar Padr√£o</button>
      </div>

      <div id="projecaoResults" style="margin-top:15px; display:none">
        <h3>Resultados da Proje√ß√£o</h3>
        <div class="metric-grid">
          <div class="metric"><div class="val" id="clientesProjetados">0</div><div class="subtle">Clientes no Final</div></div>
          <div class="metric"><div class="val" id="mrrProjetado">R$ 0</div><div class="subtle">MRR Projetado Final</div></div>
          <div class="metric"><div class="val" id="breakEvenProjetado">0</div><div class="subtle">Break-even (m√™s)</div></div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px; background:linear-gradient(135deg, rgba(34,211,238,.12), rgba(124,58,237,.12)); border:2px solid rgba(34,211,238,.3)">
      <h2>üíº Gerador de Or√ßamento para Cliente</h2>
      <p class="subtle">Configure um or√ßamento personalizado para apresentar ao seu cliente</p>
      
      <div class="row">
        <div>
          <label>üë§ Nome do Cliente</label>
          <input id="nomeCliente" type="text" placeholder="Ex: Empresa ABC Ltda"/>
        </div>
        <div>
          <label>üìß Email do Cliente</label>
          <input id="emailCliente" type="text" placeholder="contato@empresaabc.com"/>
        </div>
      </div>

      <h3>üì¶ Sele√ß√£o de Plano Base</h3>
      <div class="row">
        <div>
          <label>Plano Escolhido</label>
          <select id="planoEscolhido" style="width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; font-size:14px;">
            <option value="mei">üë∂ MEI</option>
            <option value="contador">üìä Contador</option>
            <option value="basico">üì¶ B√°sico</option>
            <option value="inter">‚ö° Intermedi√°rio</option>
            <option value="premium">üöÄ Premium</option>
          </select>
        </div>
        <div>
          <label>üéØ Ajuste de Pre√ßo (%)</label>
          <input id="ajustePreco" type="number" min="-50" max="100" step="1" value="0" placeholder="Ex: -10 para desconto de 10%"/>
        </div>
      </div>

      <h3>üéÅ Adicionais Selecionados</h3>
      <div id="seletorAdicionais" class="row" style="max-height:200px; overflow-y:auto; border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:10px; margin-bottom:10px;">
        <!-- Ser√° preenchido dinamicamente -->
      </div>

      <div class="row">
        <div>
          <label>üí≥ Desconto Adicional (R$)</label>
          <input id="descontoAdicional" type="number" min="0" step="10" value="0" placeholder="Desconto em reais"/>
        </div>
        <div>
          <label>üìÖ Vig√™ncia da Proposta (dias)</label>
          <input id="vigenciaProposta" type="number" min="1" max="365" step="1" value="30"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>üìù Observa√ß√µes da Proposta</label>
          <textarea id="observacoesProposta" style="width:100%; background:#0a0f1a; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; font-size:14px; height:80px; resize:vertical;" placeholder="Ex: Desconto especial para contrato anual, treinamento inclu√≠do, etc."></textarea>
        </div>
      </div>

      <div class="actions" style="margin-top:15px">
        <button onclick="gerarOrcamento()">üíº Gerar Or√ßamento</button>
        <button class="ghost" onclick="exportarOrcamentoPDF()">üìÑ Exportar PDF</button>
        <button class="ghost" onclick="limparOrcamento()">üóëÔ∏è Limpar</button>
      </div>

      <!-- Resultado do Or√ßamento -->
      <div id="resultadoOrcamento" style="margin-top:20px; display:none; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:20px;">
        <h3 style="text-align:center; color:var(--brand)">üí∞ Proposta Comercial - Info √Ågil Sistemas</h3>
        
        <div class="row" style="margin-bottom:15px">
          <div><strong>Cliente:</strong> <span id="orcamentoNome">-</span></div>
          <div><strong>Email:</strong> <span id="orcamentoEmail">-</span></div>
        </div>
        <div class="row" style="margin-bottom:15px">
          <div><strong>Data:</strong> <span id="orcamentoData">-</span></div>
          <div><strong>Validade:</strong> <span id="orcamentoValidade">-</span> dias</div>
        </div>

        <table style="width:100%; margin:15px 0; border:1px solid rgba(255,255,255,.2)">
          <thead>
            <tr style="background:rgba(255,255,255,.1)">
              <th style="padding:12px; text-align:left">Item</th>
              <th style="padding:12px; text-align:center">Qtd</th>
              <th style="padding:12px; text-align:right">Valor Unit.</th>
              <th style="padding:12px; text-align:right">Total</th>
            </tr>
          </thead>
          <tbody id="tabelaOrcamento">
            <!-- Ser√° preenchido dinamicamente -->
          </tbody>
          <tfoot>
            <tr style="background:rgba(255,255,255,.1); font-weight:bold">
              <td colspan="3" style="padding:12px; text-align:right">VALOR TOTAL MENSAL:</td>
              <td style="padding:12px; text-align:right; color:var(--brand); font-size:18px" id="valorTotalOrcamento">R$ 0,00</td>
            </tr>
          </tfoot>
        </table>

        <div id="observacoesOrcamento" style="margin-top:15px; padding:10px; background:rgba(255,255,255,.05); border-radius:8px; display:none;">
          <strong>üìã Observa√ß√µes:</strong>
          <p id="textoObservacoes" style="margin:5px 0 0 0; color:var(--muted)"></p>
        </div>

        <div class="metric-grid" style="margin-top:15px">
          <div class="metric"><div class="val" id="valorAnual">R$ 0</div><div class="subtle">Valor Anual</div></div>
          <div class="metric"><div class="val" id="economiaAnual">R$ 0</div><div class="subtle">Economia vs Tabela</div></div>
          <div class="metric"><div class="val" id="roiCliente">0%</div><div class="subtle">ROI Estimado Cliente</div></div>
        </div>
      </div>
    </section>
  </div>
<script>
    // Vari√°veis globais
    let dadosCalculados = {};
    let adicionaisSelecionados = {};

    // DADOS PADR√ÉO PARA ADICIONAIS
    let adicionaisRaw = [
      // Muito recomendado
      {nome:"WhatsApp",     custo:20,   tipo:"muito", id: "addon_1"},
      {nome:"Boleto",       custo:25,   tipo:"muito", id: "addon_2"},
      {nome:"Integra√ß√£o Pix",custo:17,  tipo:"muito", id: "addon_3"},
      {nome:"Assinador",    custo:25,   tipo:"muito", id: "addon_4"},
      {nome:"For√ßa de Vendas", custo:15,tipo:"muito", id: "addon_5"},
      // Moderado
      {nome:"Contrato",     custo:30,   tipo:"moderado", id: "addon_6"},
      {nome:"Lote",         custo:25,   tipo:"moderado", id: "addon_7"},
      {nome:"SEUPOS",       custo:20,   tipo:"moderado", id: "addon_8"},
      {nome:"Averba√ß√£o",    custo:18,   tipo:"moderado", id: "addon_9"},
      {nome:"Promo√ß√£o",     custo:20,   tipo:"moderado", id: "addon_10"},
      // Opcional
      {nome:"TEF Sitef",    custo:130,  tipo:"opcional", id: "addon_11"},
      {nome:"TEF Adicional",custo:32,   tipo:"opcional", id: "addon_12"},
      {nome:"SEUPOS + STONE", custo:25, tipo:"opcional", id: "addon_13"},
      {nome:"Card√°pio Digital", custo:15, tipo:"opcional", id: "addon_14"},
      {nome:"Declara√ß√£o de Importa√ß√£o", custo:20, tipo:"opcional", id: "addon_15"}
    ];

    // VALIDA√á√ïES E AUTO-CORRE√á√ïES
    function validarDistribuicao() {
      const inputs = ['distribMei', 'distribContador', 'distribBasico', 'distribInter', 'distribPremium'];
      const valores = inputs.map(id => parseFloat(document.getElementById(id).value) || 0);
      const soma = valores.reduce((a, b) => a + b, 0);
      
      const somaEl = document.getElementById('somaDistribuicao');
      somaEl.textContent = `Total: ${soma.toFixed(1)}%`;
      
      if (Math.abs(soma - 100) > 0.1) {
        somaEl.style.color = 'var(--danger)';
        inputs.forEach(id => document.getElementById(id).classList.add('validation-error'));
      } else {
        somaEl.style.color = 'var(--ok)';
        inputs.forEach(id => document.getElementById(id).classList.remove('validation-error'));
      }
    }

    function autoCorrigirDistribuicao() {
      const inputs = ['distribMei', 'distribContador', 'distribBasico', 'distribInter', 'distribPremium'];
      const valores = inputs.map(id => parseFloat(document.getElementById(id).value) || 0);
      const soma = valores.reduce((a, b) => a + b, 0);
      
      if (soma === 0) return;
      
      const fator = 100 / soma;
      let somaCorrigida = 0;
      inputs.forEach((id, i) => {
        let novoValor = valores[i] * fator;
        document.getElementById(id).value = novoValor.toFixed(1);
        somaCorrigida += parseFloat(novoValor.toFixed(1));
      });

      // Ajuste fino para garantir que a soma seja exatamente 100
      let diferenca = 100 - somaCorrigida;
      if (diferenca !== 0) {
          let ultimoInput = document.getElementById(inputs[inputs.length - 1]);
          ultimoInput.value = (parseFloat(ultimoInput.value) + diferenca).toFixed(1);
      }
      
      validarDistribuicao();
    }

    function validarCAC() {
        if (!dadosCalculados?.resultados?.planos) return;
        const inputs = ['cacMei', 'cacContador', 'cacBasico', 'cacInter', 'cacPremium'];
        const planos = ['mei', 'contador', 'basico', 'inter', 'premium'];
        
        inputs.forEach((cacId, i) => {
            const cacEl = document.getElementById(cacId);
            const cac = parseFloat(cacEl.value) || 0;
            const planoData = dadosCalculados.resultados.planos[planos[i]];
            
            if (planoData && cac > planoData.preco * 3) {
                cacEl.classList.add('validation-error');
            } else {
                cacEl.classList.remove('validation-error');
            }
        });
    }

    function mostrarAlertas() {
      const container = document.getElementById('alertasValidacao');
      container.innerHTML = '';
      const alertas = [];
      
      const soma = ['distribMei', 'distribContador', 'distribBasico', 'distribInter', 'distribPremium']
        .reduce((acc, id) => acc + (parseFloat(document.getElementById(id).value) || 0), 0);
      
      if (Math.abs(soma - 100) > 0.1) {
        alertas.push({
          tipo: 'warn',
          mensagem: `Distribui√ß√£o de planos soma ${soma.toFixed(1)}% (deve ser 100%). <button onclick="autoCorrigirDistribuicao()" style="margin-left:10px; padding:3px 8px; background:var(--ok); border:none; border-radius:4px; cursor:pointer">Auto-corrigir</button>`
        });
      }
      
      const margem = parseFloat(document.getElementById('margemLucro').value) || 0;
      if (margem < 20) {
        alertas.push({ tipo: 'warn', mensagem: `Margem de lucro baixa (${margem}%). Considere aumentar para sustentar crescimento.` });
      }
      
      const churn = parseFloat(document.getElementById('churnRate').value) || 0;
      if (churn > 8) {
        alertas.push({ tipo: 'danger', mensagem: `Churn rate alto (${churn}%/m√™s). Pode inviabilizar o modelo SaaS.` });
      }

      alertas.forEach(alerta => {
        const div = document.createElement('div');
        div.className = `alert alert-${alerta.tipo}`;
        div.innerHTML = `‚ö†Ô∏è ${alerta.mensagem}`;
        container.appendChild(div);
      });
    }

    // FUN√á√ïES DE COLETA DE DADOS
    const getValue = (id) => parseFloat(document.getElementById(id)?.value) || 0;

    function getCustosBase() {
      return {
        mei: getValue('custoMei'), contador: getValue('custoContador'), basico: getValue('custoBasico'),
        inter: getValue('custoInter'), premium: getValue('custoPremium')
      };
    }

    function getSuporte() {
      return {
        mei: getValue('suporteMei'), contador: getValue('suporteContador'), basico: getValue('suporteBasico'),
        inter: getValue('suporteInter'), premium: getValue('suportePremium')
      };
    }

    function getCAC() {
      return {
        mei: getValue('cacMei'), contador: getValue('cacContador'), basico: getValue('cacBasico'),
        inter: getValue('cacInter'), premium: getValue('cacPremium')
      };
    }

    function getInputs(){
      const custoFixo = {
        pessoal: getValue('custosPessoal'), marketing: getValue('marketing'), infraestrutura: getValue('infraestrutura'),
        contador: getValue('contador'), comunicacao: getValue('comunicacao'), outros: getValue('outros'),
        setupAvante: getValue('setupAvante'), contingencia: getValue('custosContingencia')
      };
      
      const parametros = {
        tipoOperacao: document.getElementById('tipoOperacao')?.value,
        margemLucro: getValue('margemLucro') / 100,
        metaClientes: getValue('metaClientes'),
        distribuicao: {
            mei: getValue('distribMei') / 100, contador: getValue('distribContador') / 100, basico: getValue('distribBasico') / 100,
            inter: getValue('distribInter') / 100, premium: getValue('distribPremium') / 100
        },
        churnRate: getValue('churnRate') / 100,
        churnMelhorado: getValue('churnMelhorado') / 100,
        impostos: getValue('impostos') / 100,
        comissoes: getValue('comissoes') / 100,
        whiteLabelPct: getValue('whiteLabelPct') / 100,
        sazonalidade: getValue('sazonalidade'),
        margemAdicionais: getValue('margemAdicionais') / 100,
        txAdesao: {
            muito: getValue('txMuito') / 100, moderado: getValue('txMod') / 100, opcional: getValue('txOpc') / 100
        }
      };
      
      return {custoFixo, parametros};
    }

    // FUN√á√ïES DE C√ÅLCULO
    function calcularPrecoPlano(plano, custoBase, suporte, custoFixoTotal, p, cac){
      const custoFixoPorCliente = custoFixoTotal / Math.max(1, p.metaClientes);
      const custoDireto = custoBase + suporte + custoFixoPorCliente;
      
      let percSobrePreco = p.impostos + p.comissoes;
      if (p.tipoOperacao === 'white_label' || p.tipoOperacao === 'hibrido') {
          percSobrePreco += p.whiteLabelPct;
      }

      const denominador = (1 - p.margemLucro) * (1 - percSobrePreco);
      const preco = custoDireto / Math.max(0.01, denominador);
      
      const margem = preco - custoDireto - (preco * percSobrePreco);
      const roi = custoDireto > 0 ? margem / custoDireto : 0;
      
      const churnEfetivo = Math.max(0.001, (p.churnRate + p.churnMelhorado) / 2);
      const ltv = (preco - (custoBase + suporte)) / churnEfetivo; // LTV sobre a margem de contribui√ß√£o
      const ltvCac = cac > 0 ? ltv / cac : 0;
      
      return {
        preco: Math.round(preco), custoDireto: Math.round(custoDireto), margem: Math.round(margem), 
        roi: Math.round(roi * 100), ltv: Math.round(ltv), ltvCac: Math.round(ltvCac * 10) / 10, cac: cac
      };
    }

    // FUN√á√ïES DE RENDERIZA√á√ÉO E UI
    function money(v){ 
      if (isNaN(v) || v === null || v === undefined) return "R$ 0";
      return "R$ " + Math.round(v).toLocaleString("pt-BR", { minimumFractionDigits: 0, maximumFractionDigits: 0 }); 
    }

    function desenharCards(res){
      const custosBase = getCustosBase();
      const suporte = getSuporte();
      const map = [
        {k:'mei', titulo:'üë∂ MEI', base:custosBase.mei, sup:suporte.mei},
        {k:'contador', titulo:'üìä Contador', base:custosBase.contador, sup:suporte.contador},
        {k:'basico', titulo:'üì¶ B√°sico', base:custosBase.basico, sup:suporte.basico},
        {k:'inter', titulo:'‚ö° Intermedi√°rio', base:custosBase.inter, sup:suporte.inter},
        {k:'premium', titulo:'üöÄ Premium', base:custosBase.premium, sup:suporte.premium},
      ];
      
      const el = document.getElementById('cards');
      el.innerHTML = '';
      
      map.forEach(({k,titulo,base,sup}) => {
        const i = res.planos[k];
        const ltvCacColor = i.ltvCac >= 3 ? 'var(--ok)' : i.ltvCac >= 2 ? 'var(--warn)' : 'var(--danger)';
        
        el.innerHTML += `
          <div class="card">
            <div class="mut">Custo: ${money(base)} + ${money(sup)}</div>
            <div class="price">${money(i.preco)}</div>
            <div class="mut">${titulo}</div>
            <table style="margin-top:6px">
              <tr><td>Margem</td><td class="right">${money(i.margem)}</td></tr>
              <tr><td>ROI</td><td class="right">${i.roi}%</td></tr>
              <tr><td>LTV</td><td class="right">${money(i.ltv)}</td></tr>
              <tr><td>LTV/CAC</td><td class="right" style="color:${ltvCacColor}">${i.ltvCac}x</td></tr>
              <tr><td>CAC</td><td class="right">${money(i.cac)}</td></tr>
            </table>
          </div>`;
      });
    }

    function tabelaAddons(id, titulo, filtro, parametros){
        const itens = adicionaisRaw.filter(a => a.tipo === filtro).map(a => ({
            ...a,
            venda: Math.round(a.custo * (1 + parametros.margemAdicionais))
        }));
        
        let rows = itens.map(it => `<tr>
            <td>${it.nome}</td>
            <td class="right">${money(it.custo)}</td>
            <td class="right"><b>${money(it.venda)}</b></td>
            <td class="center"><button onclick="removerItem('${it.id}')" style="padding:4px 8px; font-size:12px; background:#ef4444">üóëÔ∏è</button></td>
        </tr>`).join('');

        const badgeMap = {
            'muito': '<span class="badge b-ok">Muito recomendado</span>',
            'moderado': '<span class="badge b-warn">Moderado</span>',
            'opcional': '<span class="badge b-dang">Opcional</span>'
        };
        
        document.getElementById(id).innerHTML += `
            <div class="card">
              <h3 style="margin:0 0 6px">${titulo} ${badgeMap[filtro]}</h3>
              <table>
                <thead><tr><th class="left">Adicional</th><th class="right">Custo</th><th class="right">Pre√ßo sugerido</th><th class="center">A√ß√£o</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>`;
        return itens;
    }

    // FUN√á√ÉO PRINCIPAL DE C√ÅLCULO
    function calcular(){
      try {
        const {custoFixo, parametros} = getInputs();
        
        const custoFixoTotal = Object.values(custoFixo).reduce((a,b)=>a+b,0);
        const custoFixoComSazonalidade = custoFixoTotal * (parametros.sazonalidade || 1);
        
        const custosBase = getCustosBase();
        const suporte = getSuporte();
        const cac = getCAC();

        const planos = {
            mei: calcularPrecoPlano('mei', custosBase.mei, suporte.mei, custoFixoComSazonalidade, parametros, cac.mei),
            contador: calcularPrecoPlano('contador', custosBase.contador, suporte.contador, custoFixoComSazonalidade, parametros, cac.contador),
            basico: calcularPrecoPlano('basico', custosBase.basico, suporte.basico, custoFixoComSazonalidade, parametros, cac.basico),
            inter: calcularPrecoPlano('inter', custosBase.inter, suporte.inter, custoFixoComSazonalidade, parametros, cac.inter),
            premium: calcularPrecoPlano('premium', custosBase.premium, suporte.premium, custoFixoComSazonalidade, parametros, cac.premium)
        };
        
        const clientesPorPlano = {
            mei: parametros.metaClientes * parametros.distribuicao.mei,
            contador: parametros.metaClientes * parametros.distribuicao.contador,
            basico: parametros.metaClientes * parametros.distribuicao.basico,
            inter: parametros.metaClientes * parametros.distribuicao.inter,
            premium: parametros.metaClientes * parametros.distribuicao.premium
        };

        const mrrPlanos = Object.keys(planos).reduce((sum, key) => sum + (clientesPorPlano[key] * planos[key].preco), 0);

        // Adicionais
        document.getElementById('addonsTables').innerHTML='';
        const addMuito = tabelaAddons('addonsTables','Pack ‚Äî Muito Recomendado','muito', parametros);
        const addMod   = tabelaAddons('addonsTables','Pack ‚Äî Moderado','moderado', parametros);
        const addOpc   = tabelaAddons('addonsTables','Pack ‚Äî Opcional','opcional', parametros);

        const calcularReceitaAdicionais = (arr, tx, itensPorCliente) => {
            const mediaVenda = arr.length ? arr.reduce((s,i)=>s+i.venda,0)/arr.length : 0;
            return parametros.metaClientes * tx * mediaVenda * itensPorCliente;
        };

        const receitaAdicionais = calcularReceitaAdicionais(addMuito, parametros.txAdesao.muito, 1.5) +
                                  calcularReceitaAdicionais(addMod, parametros.txAdesao.moderado, 1.0) +
                                  calcularReceitaAdicionais(addOpc, parametros.txAdesao.opcional, 0.5);
        
        const mrrTotal = mrrPlanos + receitaAdicionais;
        const ticketMedio = mrrTotal / Math.max(1, parametros.metaClientes);
        const breakEven = custoFixoTotal / Math.max(1, ticketMedio - (Object.values(custosBase).reduce((a,b)=>a+b,0) / Object.keys(custosBase).length));
        
        const ltvPonderado = Object.keys(planos).reduce((sum, key) => sum + (planos[key].ltv * parametros.distribuicao[key]), 0);
        const cacPonderado = Object.keys(cac).reduce((sum, key) => sum + (cac[key] * parametros.distribuicao[key]), 0);
        const ltvCacRatioPonderado = cacPonderado > 0 ? ltvPonderado / cacPonderado : 0;

        // Atualizar UI
        desenharCards({planos});
        document.getElementById('mrrTotal').textContent = money(mrrTotal);
        document.getElementById('custosFixosTotal').textContent = money(custoFixoTotal);
        document.getElementById('breakEven').textContent = Math.ceil(breakEven);
        document.getElementById('ltv').textContent = money(ltvPonderado);
        document.getElementById('ltvCacRatio').textContent = ltvCacRatioPonderado.toFixed(1) + "x";
        document.getElementById('receitaAnual').textContent = money(mrrTotal * 12);
        document.getElementById('receitaAdicionaisMensal').textContent = money(receitaAdicionais);
        document.getElementById('ticketMedioComAdicionais').textContent = money(ticketMedio);
        
        dadosCalculados = { inputs: { custoFixo, parametros, custosBase, suporte, cac }, resultados: { planos, mrrTotal, breakEven, ltvPonderado, ltvCacRatioPonderado } };
        
        mostrarAlertas();
        validarCAC();

      } catch (error) {
        console.error('Erro no c√°lculo:', error);
      }
    }

    // FUN√á√ïES AUXILIARES E EVENTOS
    function resetarPadrao() {
      const defaults = {
        'custosPessoal': 8000, 'infraestrutura': 800, 'marketing': 2000, 'contador': 800,
        'comunicacao': 250, 'outros': 350, 'setupAvante': 792, 'custosContingencia': 500,
        'custoMei': 25, 'custoContador': 30, 'custoBasico': 36, 'custoInter': 56, 'custoPremium': 130,
        'suporteMei': 20, 'suporteContador': 30, 'suporteBasico': 35, 'suporteInter': 50, 'suportePremium': 80,
        'margemLucro': 40, 'metaClientes': 120,
        'distribMei': 15, 'distribContador': 20, 'distribBasico': 30, 'distribInter': 25, 'distribPremium': 10,
        'churnRate': 4, 'churnMelhorado': 2.5,
        'cacMei': 150, 'cacContador': 200, 'cacBasico': 250, 'cacInter': 350, 'cacPremium': 500,
        'impostos': 8.5, 'comissoes': 7, 'whiteLabelPct': 30, 'sazonalidade': 1.5,
        'margemAdicionais': 50, 'txMuito': 70, 'txMod': 40, 'txOpc': 20,
        'crescimentoMensal': 8, 'periodoProjecao': 12, 'metaReceitaFinal': 50000
      };
      for (const [id, value] of Object.entries(defaults)) {
        const el = document.getElementById(id);
        if (el) el.value = value;
      }
      validarDistribuicao();
      calcular();
    }

    function adicionarItem() {
      const nome = document.getElementById('novoAdicional').value.trim();
      const custo = parseFloat(document.getElementById('novoCusto').value) || 0;
      const categoria = document.getElementById('novaCategoria').value;
      if (!nome || custo <= 0) return;
      
      adicionaisRaw.push({ nome, custo, tipo: categoria, id: `addon_${Date.now()}` });
      document.getElementById('novoAdicional').value = '';
      document.getElementById('novoCusto').value = '20';
      calcular();
    }

    function removerItem(id) {
      adicionaisRaw = adicionaisRaw.filter(item => item.id !== id);
      calcular();
    }

    function exportarJSON(){
      if(!Object.keys(dadosCalculados).length){ alert("Calcule primeiro."); return; }
      const blob = new Blob([JSON.stringify(dadosCalculados, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `precificacao_saas_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    function testeRapido() {
      console.clear();
      console.log("--- DEBUG INICIADO ---");
      console.log("Valores de Input:", getInputs());
      console.log("Dados Calculados:", dadosCalculados);
      console.log("--- DEBUG FINALIZADO ---");
    }

    // INICIALIZA√á√ÉO
    window.addEventListener("load", ()=>{
      resetarPadrao(); // Popula com valores padr√£o e j√° faz o primeiro c√°lculo
      criarSeletorAdicionais(); // Cria a lista de checkboxes para o or√ßamento
    });

    // --- SE√á√ÉO DO GERADOR DE OR√áAMENTO ---

    function criarSeletorAdicionais() {
      const container = document.getElementById('seletorAdicionais');
      container.innerHTML = '';
      const { parametros } = getInputs();
      
      adicionaisRaw.forEach(item => {
        const precoVenda = Math.round(item.custo * (1 + parametros.margemAdicionais));
        const badge = item.tipo === 'muito' ? 'b-ok' : item.tipo === 'moderado' ? 'b-warn' : 'b-dang';
        
        container.innerHTML += `
          <div style="display:flex; align-items:center; margin:5px 0; padding:8px; background:rgba(255,255,255,.03); border-radius:6px">
            <input type="checkbox" id="adicional_${item.id}" onchange="toggleAdicional('${item.id}')" style="margin-right:10px">
            <label for="adicional_${item.id}" style="flex:1; cursor:pointer; margin:0">
              <span class="badge ${badge}" style="margin-right:8px">${item.nome}</span>
              <span style="color:var(--muted); font-size:12px">${money(precoVenda)}/m√™s</span>
            </label>
          </div>`;
      });
    }

    function toggleAdicional(id) {
      const checkbox = document.getElementById(`adicional_${id}`);
      if (checkbox.checked) {
        adicionaisSelecionados[id] = adicionaisRaw.find(a => a.id === id);
      } else {
        delete adicionaisSelecionados[id];
      }
    }

    function gerarOrcamento() {
      if (!dadosCalculados.resultados) {
        alert("Execute o c√°lculo principal primeiro.");
        return;
      }
      const { parametros } = getInputs();
      
      const nomeCliente = document.getElementById('nomeCliente').value.trim() || 'N√£o informado';
      const planoEscolhido = document.getElementById('planoEscolhido').value;
      const ajustePreco = getValue('ajustePreco') / 100;
      const descontoAdicional = getValue('descontoAdicional');
      
      const precoOriginalPlano = dadosCalculados.resultados.planos[planoEscolhido].preco;
      const precoPlanoComAjuste = precoOriginalPlano * (1 + ajustePreco);

      const tbody = document.getElementById('tabelaOrcamento');
      tbody.innerHTML = `<tr>
        <td>Plano ${planoEscolhido.charAt(0).toUpperCase() + planoEscolhido.slice(1)}</td>
        <td class="center">1</td>
        <td class="right">${money(precoPlanoComAjuste)}</td>
        <td class="right">${money(precoPlanoComAjuste)}</td>
      </tr>`;
      
      let totalAdicionais = 0;
      Object.values(adicionaisSelecionados).forEach(item => {
        const precoVenda = Math.round(item.custo * (1 + parametros.margemAdicionais));
        totalAdicionais += precoVenda;
        tbody.innerHTML += `<tr>
          <td>+ ${item.nome}</td>
          <td class="center">1</td>
          <td class="right">${money(precoVenda)}</td>
          <td class="right">${money(precoVenda)}</td>
        </tr>`;
      });
      
      const valorFinal = precoPlanoComAjuste + totalAdicionais - descontoAdicional;

      document.getElementById('orcamentoNome').textContent = nomeCliente;
      document.getElementById('orcamentoData').textContent = new Date().toLocaleDateString('pt-BR');
      document.getElementById('valorTotalOrcamento').textContent = money(valorFinal);
      document.getElementById('valorAnual').textContent = money(valorFinal * 12);
      
      document.getElementById('resultadoOrcamento').style.display = 'block';
    }

    function limparOrcamento() {
        document.getElementById('nomeCliente').value = '';
        document.getElementById('emailCliente').value = '';
        document.getElementById('planoEscolhido').value = 'mei';
        document.getElementById('ajustePreco').value = '0';
        document.getElementById('descontoAdicional').value = '0';
        adicionaisSelecionados = {};
        document.querySelectorAll('#seletorAdicionais input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.getElementById('resultadoOrcamento').style.display = 'none';
    }

    // FUN√á√ïES DE AN√ÅLISE DE CONCORR√äNCIA
    let analiseAtual = null;

    function getConcorrentes() {
      return {
        mei: parseFloat(document.getElementById('concorrenteMei').value) || 0,
        contador: parseFloat(document.getElementById('concorrenteContador').value) || 0,
        basico: parseFloat(document.getElementById('concorrenteBasico').value) || 0,
        inter: parseFloat(document.getElementById('concorrenteInter').value) || 0,
        premium: parseFloat(document.getElementById('concorrentePremium').value) || 0
      };
    }

    function analisarConcorrencia() {
      if (!dadosCalculados || !dadosCalculados.resultados) {
        alert('Execute primeiro o c√°lculo de precifica√ß√£o!');
        return;
      }

      const concorrentes = getConcorrentes();
      const nossoPrecos = dadosCalculados.resultados.planos;
      const estrategia = document.getElementById('estrategiaPosicionamento').value;
      const ajusteManual = parseFloat(document.getElementById('ajusteManual').value) || 0;

      // Verificar se h√° pelo menos um pre√ßo de concorrente
      const temConcorrente = Object.values(concorrentes).some(preco => preco > 0);
      if (!temConcorrente) {
        document.getElementById('resultadosConcorrencia').style.display = 'none';
        return;
      }

      const analise = {};
      const sugestoes = [];
      let totalImpactoMRR = 0;

      Object.keys(nossoPrecos).forEach(plano => {
        const nossoPreco = nossoPrecos[plano].preco;
        const precoConcorrente = concorrentes[plano];
        
        if (precoConcorrente > 0) {
          const diferenca = ((nossoPreco - precoConcorrente) / precoConcorrente) * 100;
          const novoPreco = calcularNovoPreco(precoConcorrente, estrategia, ajusteManual);
          const ajusteNecessario = ((novoPreco - nossoPreco) / nossoPreco) * 100;
          
          analise[plano] = {
            nossoPreco,
            precoConcorrente,
            novoPreco,
            diferenca,
            ajusteNecessario,
            competitivo: Math.abs(diferenca) <= 10,
            status: diferenca > 20 ? 'caro' : diferenca < -20 ? 'barato' : 'equilibrado'
          };

          // Calcular impacto no MRR
          const clientesPlano = dadosCalculados.inputs.parametros.metaClientes * 
                               dadosCalculados.inputs.parametros.distribuicao[plano];
          const impactoPlano = (novoPreco - nossoPreco) * clientesPlano;
          totalImpactoMRR += impactoPlano;

          // Gerar sugest√µes
          if (Math.abs(ajusteNecessario) > 5) {
            sugestoes.push({
              plano: plano.toUpperCase(),
              acao: ajusteNecessario > 0 ? 'Aumentar' : 'Reduzir',
              percentual: Math.abs(ajusteNecessario).toFixed(1),
              precoAtual: nossoPreco,
              precoSugerido: novoPreco,
              justificativa: gerarJustificativa(analise[plano], estrategia)
            });
          }
        }
      });

      analiseAtual = { analise, sugestoes, impactoMRR: totalImpactoMRR, estrategia };
      exibirResultadosAnalise();
    }

    function calcularNovoPreco(precoConcorrente, estrategia, ajusteManual) {
      let fator = 1;
      
      switch (estrategia) {
        case 'competitivo':
          fator = 0.98; // 2% abaixo do concorrente
          break;
        case 'premium':
          fator = 1.15; // 15% acima do concorrente
          break;
        case 'agressivo':
          fator = 0.85; // 15% abaixo do concorrente
          break;
        case 'value':
          fator = 1.08; // 8% acima do concorrente
          break;
      }

      return Math.round(precoConcorrente * fator * (1 + ajusteManual / 100));
    }

    function gerarJustificativa(dados, estrategia) {
      if (dados.status === 'caro') {
        return estrategia === 'premium' ? 
          'Manter posicionamento premium com valor agregado' :
          'Reduzir para aumentar competitividade';
      } else if (dados.status === 'barato') {
        return 'Aumentar pre√ßo para capturar mais valor de mercado';
      } else {
        return 'Ajuste fino para otimizar posicionamento';
      }
    }

    function exibirResultadosAnalise() {
      if (!analiseAtual) return;

      const { analise, sugestoes, impactoMRR, estrategia } = analiseAtual;

      // Exibir cards de compara√ß√£o
      const cardsContainer = document.getElementById('cardsComparacao');
      cardsContainer.innerHTML = '';

      Object.keys(analise).forEach(plano => {
        const dados = analise[plano];
        const statusColor = dados.competitivo ? 'var(--ok)' : 
                           dados.status === 'caro' ? 'var(--danger)' : 'var(--warn)';
        
        const card = `
          <div class="card" style="border-left: 4px solid ${statusColor}">
            <div class="mut">Plano ${plano.toUpperCase()}</div>
            <div style="margin: 8px 0;">
              <div style="font-size: 14px;">Nosso: <strong>${money(dados.nossoPreco)}</strong></div>
              <div style="font-size: 14px;">Concorrente: <strong>${money(dados.precoConcorrente)}</strong></div>
              <div style="font-size: 14px; color: ${statusColor};">Sugerido: <strong>${money(dados.novoPreco)}</strong></div>
            </div>
            <div class="mut">
              Diferen√ßa: ${dados.diferenca > 0 ? '+' : ''}${dados.diferenca.toFixed(1)}%
            </div>
          </div>
        `;
        cardsContainer.insertAdjacentHTML('beforeend', card);
      });

      // Exibir sugest√µes
      const sugestoesContainer = document.getElementById('sugestoesAjuste');
      if (sugestoes.length > 0) {
        let sugestoesHTML = '<div class="alert alert-info" style="margin-bottom: 15px;">';
        sugestoes.forEach(sug => {
          sugestoesHTML += `
            <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
              <strong>${sug.plano}:</strong> ${sug.acao} ${sug.percentual}% 
              (${money(sug.precoAtual)} ‚Üí ${money(sug.precoSugerido)})
              <br><small>${sug.justificativa}</small>
            </div>
          `;
        });
        sugestoesHTML += '</div>';
        sugestoesContainer.innerHTML = sugestoesHTML;
      } else {
        sugestoesContainer.innerHTML = '<div class="alert alert-info">‚úÖ Pre√ßos est√£o bem posicionados no mercado!</div>';
      }

      // Calcular m√©tricas de impacto
      const impactoAnual = impactoMRR * 12;
      const { parametros } = dadosCalculados.inputs;
      const novaMargemMedia = calcularNovaMargemMedia();
      const scoreCompetitividade = calcularScoreCompetitividade();

      document.getElementById('impactoMRR').textContent = money(impactoMRR);
      document.getElementById('impactoAnual').textContent = money(impactoAnual);
      document.getElementById('novaMargemMedia').textContent = novaMargemMedia.toFixed(1) + '%';
      document.getElementById('competitividadeScore').textContent = scoreCompetitividade.toFixed(1) + '/10';

      document.getElementById('resultadosConcorrencia').style.display = 'block';
    }

    function calcularNovaMargemMedia() {
      if (!analiseAtual) return 0;
      
      const { parametros, custosBase, suporte } = dadosCalculados.inputs;
      const custoFixoTotal = Object.values(dadosCalculados.inputs.custoFixo).reduce((a,b)=>a+b,0);
      const custoFixoComSazonalidade = custoFixoTotal * (parametros.sazonalidade || 1);
      const custoFixoPorCliente = custoFixoComSazonalidade / Math.max(1, parametros.metaClientes);
      
      let margemPonderada = 0;
      let totalDistribuicao = 0;

      Object.keys(analiseAtual.analise).forEach(plano => {
        const dados = analiseAtual.analise[plano];
        const custoDireto = custosBase[plano] + getSuporte()[plano] + custoFixoPorCliente;
        const margem = ((dados.novoPreco - custoDireto) / dados.novoPreco) * 100;
        const distribuicao = parametros.distribuicao[plano];
        
        margemPonderada += margem * distribuicao;
        totalDistribuicao += distribuicao;
      });

      return totalDistribuicao > 0 ? margemPonderada / totalDistribuicao : 0;
    }

    function calcularScoreCompetitividade() {
      if (!analiseAtual) return 0;
      
      const scores = Object.values(analiseAtual.analise).map(dados => {
        if (dados.competitivo) return 10;
        if (Math.abs(dados.diferenca) <= 20) return 7;
        if (Math.abs(dados.diferenca) <= 40) return 4;
        return 1;
      });

      return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
    }

    function aplicarSugestoes() {
      if (!analiseAtual || analiseAtual.sugestoes.length === 0) {
        alert('N√£o h√° sugest√µes para aplicar!');
        return;
      }

      const confirmar = confirm(`Aplicar ${analiseAtual.sugestoes.length} sugest√£o(√µes) de ajuste de pre√ßo?`);
      if (!confirmar) return;

      // Aqui voc√™ pode implementar a l√≥gica para aplicar as sugest√µes
      // Por exemplo, ajustar margens ou custos para atingir os pre√ßos sugeridos
      alert('Funcionalidade de aplica√ß√£o autom√°tica ser√° implementada em vers√£o futura.\nPor enquanto, use as sugest√µes como refer√™ncia manual.');
    }

    function limparConcorrencia() {
      ['concorrenteMei', 'concorrenteContador', 'concorrenteBasico', 'concorrenteInter', 'concorrentePremium']
        .forEach(id => document.getElementById(id).value = '0');
      
      document.getElementById('estrategiaPosicionamento').value = 'competitivo';
      document.getElementById('ajusteManual').value = '0';
      document.getElementById('resultadosConcorrencia').style.display = 'none';
      analiseAtual = null;
    }

    function exportarOrcamentoPDF() {
        const orcamentoHtml = document.getElementById('resultadoOrcamento').innerHTML;
        const win = window.open('', '', 'height=700,width=700');
        win.document.write('<html><head><title>Or√ßamento</title>');
        win.document.write('<style>body{font-family: sans-serif;} table{width:100%; border-collapse:collapse;} td,th{border:1px solid #ddd; padding:8px;} .right{text-align:right;} .center{text-align:center;}</style>');
        win.document.write('</head><body>');
        win.document.write(orcamentoHtml);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }
  </script>